<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DPR System – Final One Page</title>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h2{color:#fff;padding:10px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:6px}
input,select,button,textarea{width:100%;padding:6px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
.paid{background:#cfe2ff}
.unpaid{background:#ffe5b4}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Change Admin Password</h3>
Old Password <input type="password" id="oldPass">
New Password <input type="password" id="newPass">
Confirm New Password <input type="password" id="cnfPass">
<button onclick="changeAdminPassword()">Change Password</button>
</div>

<div class="box">
<h3>Create User</h3>
Username <input id="cu">
Password <input id="cp">
Name <input id="cn">
Location <input id="cl">
Role
<select id="cr">
<option value="team">Team</option>
<option value="supervisor">Supervisor</option>
</select>
<button onclick="createUser()">Create User</button>
</div>

<div class="box">
<h3>Existing Users</h3>
<table>
<thead>
<tr><th>User</th><th>Name</th><th>Role</th><th>Location</th><th>Advance</th><th>Action</th></tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<div class="box">
<h3>Give Advance</h3>
User <select id="advUser"></select>
Amount <input type="number" id="advAmt">
<button onclick="giveAdvance()">Give Advance</button>
</div>

<div class="box">
<h3>Approved Entries</h3>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th><th>Amount</th>
<th>Status</th><th>Payment</th><th>Action</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<div class="box">
<b>Total Paid:</b> ₹<span id="paidT">0</span> |
<b>Total Pending:</b> ₹<span id="pendT">0</span>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Comment</th><th>Action</th>
</tr>
</thead>
<tbody id="supTable"></tbody>
</table>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span><br>
<b>Advance Balance:</b> ₹<span id="bal"></span>
</div>

<div class="box">
<button onclick="toggleBox('convBox')">➕ CONVEYANCE</button>
<button onclick="toggleBox('expBox')">➕ EXPENSE</button>
</div>

<div class="box hidden" id="convBox">
<h3>Conveyance</h3>
Date <input type="date" id="cdate">
From <input id="cfrom">
To <input id="cto">
Transport
<select id="cmode">
<option>Bus</option><option>Train</option><option>Bike</option>
<option>Flight</option><option>Taxi</option><option>Auto</option>
</select>
Members <input type="number" id="cmem" value="1" oninput="calcConv()">
Amount / Person <input type="number" id="cper" oninput="calcConv()">
Total Amount <input type="number" id="ctotal">
<button onclick="saveConveyance()">Submit Conveyance</button>
</div>

<div class="box hidden" id="expBox">
<h3>Expense</h3>
Date <input type="date" id="edate">
Category
<select id="ecat"><option>Office</option><option>Other</option></select>
Description <input id="edesc">
Amount <input type="number" id="eamt">
<button onclick="saveExpense()">Submit Expense</button>
</div>

<div class="box">
<h3>My Entries</h3>
<table>
<thead>
<tr><th>Date</th><th>Detail</th><th>Amount</th><th>Status</th></tr>
</thead>
<tbody id="teamTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
/* ================= GOOGLE SHEET CONFIG ================= */
const SHEET_API = "https://script.google.com/macros/s/AKfycbxG6Di2BRNd1cieq0rj12DTUIxa6hUtr-fTqqn0I-kqIGFg0etqxDdmDwvPVFwJsShE/exec";

/* ================= LOCAL DATA ================= */
let USERS = JSON.parse(localStorage.getItem("USERS")) || [
 {username:"admin",password:"admin",role:"admin",name:"Admin"},
 {username:"sup",password:"sup",role:"supervisor",name:"Supervisor",advance:0},
 {username:"team",password:"team",role:"team",name:"Team",location:"Site-1",advance:0}
];

let DATA = JSON.parse(localStorage.getItem("DATA")) || [];
let currentUser = JSON.parse(localStorage.getItem("CURRENT_USER")) || null;

/* ================= AUTO LOGIN AFTER REFRESH ================= */
if(currentUser){
  loginBox.classList.add("hidden");
  if(currentUser.role==="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
  if(currentUser.role==="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
  if(currentUser.role==="team"){teamPanel.classList.remove("hidden");initTeam();}
}

/* ================= LOGIN ================= */
function login(){
  let u = USERS.find(x=>x.username===luser.value && x.password===lpass.value);
  if(!u) return alert("Wrong Login");

  currentUser = u;
  localStorage.setItem("CURRENT_USER",JSON.stringify(currentUser));

  loginBox.classList.add("hidden");
  if(u.role==="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
  if(u.role==="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
  if(u.role==="team"){teamPanel.classList.remove("hidden");initTeam();}
}

function logout(){
  localStorage.removeItem("CURRENT_USER");
  location.reload();
}

/* ================= GOOGLE SHEET SYNC ================= */
function syncToSheet(entry){
  fetch(SHEET_API,{
    method:"POST",
    body:JSON.stringify(entry),
    headers:{"Content-Type":"application/json"}
  }).catch(()=>{});
}

/* ================= TEAM ================= */
function toggleBox(id){
  convBox.classList.add("hidden");
  expBox.classList.add("hidden");
  document.getElementById(id).classList.remove("hidden");
}
function initTeam(){
  tname.innerText=currentUser.name;
  tloc.innerText=currentUser.location;
  bal.innerText=currentUser.advance||0;
  cdate.valueAsDate=edate.valueAsDate=new Date();
  loadTeam();
}
function calcConv(){
  ctotal.value=(+cmem.value||0)*(+cper.value||0);
}
function saveConveyance(){
  let amt=+ctotal.value;
  let entry={
    username:currentUser.username,
    role:currentUser.role,
    date:cdate.value,
    detail:`Conveyance ${cmode.value} ${cfrom.value} to ${cto.value}`,
    amount:amt,
    status:"Pending"
  };
  DATA.push(entry);
  currentUser.advance-=amt;
  saveAll();
  syncToSheet(entry);
}
function saveExpense(){
  let amt=+eamt.value;
  let entry={
    username:currentUser.username,
    role:currentUser.role,
    date:edate.value,
    detail:`Expense (${ecat.value}) - ${edesc.value}`,
    amount:amt,
    status:"Pending"
  };
  DATA.push(entry);
  currentUser.advance-=amt;
  saveAll();
  syncToSheet(entry);
}
function loadTeam(){
  bal.innerText=currentUser.advance||0;
  teamTable.innerHTML="";
  DATA.filter(d=>d.username===currentUser.username).forEach(d=>{
    let cls=d.status==="Approved"?"approved":d.status==="Rejected"?"rejected":"pending";
    teamTable.innerHTML+=`<tr class="${cls}">
      <td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td><td>${d.status}</td>
    </tr>`;
  });
}

/* ================= SUPERVISOR ================= */
function loadSup(){
  supTable.innerHTML="";
  DATA.forEach((d,i)=>{
    let cls=d.status==="Approved"?"approved":d.status==="Rejected"?"rejected":"pending";
    supTable.innerHTML+=`<tr class="${cls}">
      <td>${d.username}</td><td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td>
      <td>${d.status}</td>
      <td><textarea onchange="DATA[${i}].comment=this.value;saveAll()">${d.comment||""}</textarea></td>
      <td>
        <button onclick="DATA[${i}].status='Approved';saveAll()">Approve</button>
        <button onclick="DATA[${i}].status='Rejected';saveAll()">Reject</button>
      </td>
    </tr>`;
  });
}

/* ================= ADMIN ================= */
function loadAdmin(){
  userTable.innerHTML="";
  USERS.forEach((u,i)=>{
    let del=u.role!=="admin"?`<button onclick="USERS.splice(${i},1);saveAll()">Delete</button>`:"";
    userTable.innerHTML+=`<tr>
      <td>${u.username}</td><td>${u.name||""}</td><td>${u.role}</td>
      <td>${u.location||""}</td><td>${u.advance||0}</td><td>${del}</td>
    </tr>`;
  });
}
function createUser(){
  USERS.push({username:cu.value,password:cp.value,name:cn.value,location:cl.value,role:cr.value,advance:0});
  saveAll();
}
function giveAdvance(){
  let u=USERS.find(x=>x.username===advUser.value);
  u.advance+=+advAmt.value;
  saveAll();
}

/* ================= SAVE ================= */
function saveAll(){
  localStorage.setItem("USERS",JSON.stringify(USERS));
  localStorage.setItem("DATA",JSON.stringify(DATA));
  localStorage.setItem("CURRENT_USER",JSON.stringify(currentUser));
  if(currentUser?.role==="admin")loadAdmin();
  if(currentUser?.role==="supervisor")loadSup();
  if(currentUser?.role==="team")loadTeam();
}
</script>

</body>
</html>
