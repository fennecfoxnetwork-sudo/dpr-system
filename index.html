<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DPR System â€“ Final One Page</title>

<style>
body{font-family:system-ui,-apple-system,Roboto,Arial;background:#f2f2f2;padding:10px}
h2{color:#fff;padding:10px;border-radius:6px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:12px;margin-bottom:12px;border-radius:6px}
input,select,button,textarea{width:100%;padding:8px;margin:6px 0;font-size:16px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
.paid{background:#cfe2ff}
.unpaid{background:#ffe5b4}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Change Admin Password</h3>
<input id="oldPass" type="password" placeholder="Old password">
<input id="newPass" type="password" placeholder="New password">
<input id="cnfPass" type="password" placeholder="Confirm password">
<button onclick="changeAdminPassword()">Change Password</button>
</div>

<div class="box">
<h3>Create User</h3>
<input id="cu" placeholder="Username">
<input id="cp" placeholder="Password">
<input id="cn" placeholder="Name">
<input id="cl" placeholder="Location">
<select id="cr">
<option value="team">Team</option>
<option value="supervisor">Supervisor</option>
</select>
<button onclick="createUser()">Create User</button>
</div>

<div class="box">
<h3>Existing Users</h3>
<table>
<thead><tr>
<th>User</th><th>Name</th><th>Role</th><th>Location</th><th>Advance</th>
</tr></thead>
<tbody id="userTable"></tbody>
</table>
</div>

<div class="box">
<h3>Give Advance</h3>
<select id="advUser"></select>
<input id="advAmt" type="number" placeholder="Amount">
<button onclick="giveAdvance()">Give Advance</button>
</div>

<div class="box">
<h3>Approved Entries</h3>
<table>
<thead><tr>
<th>User</th><th>Date</th><th>Detail</th><th>Amount</th>
<th>Status</th><th>Payment</th><th>Action</th>
</tr></thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<div class="box">
<b>Total Paid:</b> â‚¹<span id="paidT">0</span> |
<b>Total Pending:</b> â‚¹<span id="pendT">0</span>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<table>
<thead><tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Action</th>
</tr></thead>
<tbody id="supTable"></tbody>
</table>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span><br>
<b>Advance Balance:</b> â‚¹<span id="bal"></span>
</div>

<div class="box">
<button onclick="toggleBox('convBox')">âž• CONVEYANCE</button>
<button onclick="toggleBox('expBox')">âž• EXPENSE</button>
</div>

<div class="box hidden" id="convBox">
<h3>Conveyance</h3>
<input type="date" id="cdate">
<input id="cfrom" placeholder="From">
<input id="cto" placeholder="To">
<select id="cmode">
<option>Bus</option><option>Train</option><option>Bike</option>
<option>Taxi</option><option>Auto</option>
</select>
<input type="number" id="cmem" value="1" oninput="calcConv()">
<input type="number" id="cper" placeholder="Amount per person" oninput="calcConv()">
<input id="ctotal" placeholder="Total">
<button onclick="saveConveyance()">Submit</button>
</div>

<div class="box hidden" id="expBox">
<h3>Expense</h3>
<input type="date" id="edate">
<select id="ecat"><option>Office</option><option>Other</option></select>
<input id="edesc" placeholder="Description">
<input id="eamt" placeholder="Amount">
<button onclick="saveExpense()">Submit</button>
</div>

<div class="box">
<h3>My Entries</h3>
<table>
<thead><tr>
<th>Date</th><th>Detail</th><th>Amount</th><th>Status</th>
</tr></thead>
<tbody id="teamTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
/* ðŸ”´ PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL */
const GOOGLE_API_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

let USERS = JSON.parse(localStorage.getItem("USERS")) || [
 {username:"admin",password:"admin",role:"admin",name:"Admin"},
 {username:"sup",password:"sup",role:"supervisor",name:"Supervisor",advance:0},
 {username:"team",password:"team",role:"team",name:"Team",location:"Site-1",advance:0}
];

let DATA = JSON.parse(localStorage.getItem("DATA")) || [];
let currentUser=null;

/* ---------- AUTH ---------- */
function login(){
 let u=USERS.find(x=>x.username==luser.value && x.password==lpass.value);
 if(!u) return alert("Wrong Login");
 currentUser=u;
 loginBox.classList.add("hidden");
 if(u.role=="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
 if(u.role=="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
 if(u.role=="team"){teamPanel.classList.remove("hidden");initTeam();}
}
function logout(){location.reload();}

/* ---------- ADMIN ---------- */
function changeAdminPassword(){
 if(oldPass.value!==currentUser.password) return alert("Old password wrong");
 if(newPass.value!==cnfPass.value) return alert("Mismatch");
 currentUser.password=newPass.value; saveAll(); alert("Password changed");
}
function createUser(){
 USERS.push({username:cu.value,password:cp.value,name:cn.value,location:cl.value,role:cr.value,advance:0});
 saveAll();
}
function giveAdvance(){
 let u=USERS.find(x=>x.username==advUser.value);
 u.advance+=+advAmt.value; saveAll();
}

/* ---------- TEAM ---------- */
function toggleBox(id){
 convBox.classList.add("hidden"); expBox.classList.add("hidden");
 document.getElementById(id).classList.remove("hidden");
}
function initTeam(){
 tname.innerText=currentUser.name;
 tloc.innerText=currentUser.location;
 bal.innerText=currentUser.advance||0;
 cdate.valueAsDate=edate.valueAsDate=new Date();
 loadTeam();
}
function calcConv(){ctotal.value=(+cmem.value||0)*(+cper.value||0);}

function saveConveyance(){
 let amt=+ctotal.value; if(!amt) return alert("Amount required");
 pushData(`Conveyance ${cmode.value} ${cfrom.value} to ${cto.value}`,amt);
}
function saveExpense(){
 let amt=+eamt.value; if(!amt||!edesc.value) return alert("Fill all");
 pushData(`Expense (${ecat.value}) - ${edesc.value}`,amt);
}
function pushData(detail,amt){
 DATA.push({
  username:currentUser.username,
  role:currentUser.role,
  date:new Date().toISOString().slice(0,10),
  detail,amount:amt,status:"Pending",synced:false
 });
 currentUser.advance-=amt;
 saveAll(); syncGoogle(); loadTeam();
}

/* ---------- LOADERS ---------- */
function loadTeam(){
 bal.innerText=currentUser.advance||0;
 teamTable.innerHTML="";
 DATA.filter(d=>d.username==currentUser.username).forEach(d=>{
  teamTable.innerHTML+=`<tr class="${d.status.toLowerCase()}">
  <td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td><td>${d.status}</td></tr>`;
 });
}
function loadSup(){
 supTable.innerHTML="";
 DATA.forEach((d,i)=>{
  supTable.innerHTML+=`<tr>
  <td>${d.username}</td><td>${d.date}</td><td>${d.detail}</td>
  <td>${d.amount}</td><td>${d.status}</td>
  <td>
  <button onclick="DATA[${i}].status='Approved';saveAll()">Approve</button>
  <button onclick="DATA[${i}].status='Rejected';saveAll()">Reject</button>
  </td></tr>`;
 });
}
function loadAdmin(){
 userTable.innerHTML="";
 USERS.forEach(u=>{
  userTable.innerHTML+=`<tr>
  <td>${u.username}</td><td>${u.name||""}</td>
  <td>${u.role}</td><td>${u.location||""}</td>
  <td>${u.advance||0}</td></tr>`;
 });
 advUser.innerHTML="";
 USERS.filter(u=>u.role!="admin").forEach(u=>advUser.innerHTML+=`<option>${u.username}</option>`);
}

/* ---------- STORAGE ---------- */
function saveAll(){
 localStorage.setItem("USERS",JSON.stringify(USERS));
 localStorage.setItem("DATA",JSON.stringify(DATA));
}

/* ---------- GOOGLE SYNC ---------- */
function syncGoogle(){
 if(!navigator.onLine || !GOOGLE_API_URL.startsWith("http")) return;
 DATA.filter(d=>!d.synced).forEach(d=>{
  fetch(GOOGLE_API_URL,{
   method:"POST",
   body:JSON.stringify(d),
   headers:{"Content-Type":"application/json"}
  }).then(()=>d.synced=true);
 });
}
window.addEventListener("online",syncGoogle);
</script>

</body>
</html>
