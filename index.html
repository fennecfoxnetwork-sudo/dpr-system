<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DPR System – Final One Page</title>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h2{color:#fff;padding:10px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:6px}
input,select,button,textarea{width:100%;padding:6px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
.paid{background:#cfe2ff}
.unpaid{background:#ffe5b4}
button{cursor:pointer}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Change Admin Password</h3>
Old Password <input type="password" id="oldPass">
New Password <input type="password" id="newPass">
Confirm Password <input type="password" id="cnfPass">
<button onclick="changeAdminPassword()">Change Password</button>
</div>

<div class="box">
<h3>Create User</h3>
Username <input id="cu">
Password <input id="cp">
Name <input id="cn">
Location <input id="cl">
Role
<select id="cr">
<option value="team">Team</option>
<option value="supervisor">Supervisor</option>
</select>
<button onclick="createUser()">Create User</button>
</div>

<div class="box">
<h3>Existing Users</h3>
<table>
<thead>
<tr><th>User</th><th>Name</th><th>Role</th><th>Location</th><th>Advance</th></tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<div class="box">
<h3>Approved Entries</h3>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="supTable"></tbody>
</table>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span><br>
<b>Advance:</b> ₹<span id="bal"></span>
</div>

<div class="box">
<h3>Add Expense</h3>
Date <input type="date" id="edate">
Description <input id="edesc">
Amount <input type="number" id="eamt">
<button onclick="saveExpense()">Submit</button>
</div>

<div class="box">
<h3>My Entries</h3>
<table>
<thead>
<tr><th>Date</th><th>Detail</th><th>Amount</th><th>Status</th></tr>
</thead>
<tbody id="teamTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
/* ===== RESET ON FIRST LOAD ===== */
if(!localStorage.getItem("INIT")){
localStorage.clear();
localStorage.setItem("INIT","1");
}

/* ===== USERS ===== */
let USERS = JSON.parse(localStorage.getItem("USERS")) || [
{username:"admin",password:"admin",role:"admin",name:"Admin"},
{username:"sup",password:"sup",role:"supervisor",name:"Supervisor"},
{username:"team",password:"team",role:"team",name:"Team",location:"Site-1",advance:0}
];

let DATA = JSON.parse(localStorage.getItem("DATA")) || [];
let currentUser=null;

function login(){
let u = USERS.find(x=>x.username===luser.value && x.password===lpass.value);
if(!u){ alert("Wrong Login"); return; }

currentUser=u;
loginBox.classList.add("hidden");

if(u.role==="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
if(u.role==="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
if(u.role==="team"){teamPanel.classList.remove("hidden");initTeam();}
}

function logout(){location.reload();}

function changeAdminPassword(){
if(oldPass.value!==currentUser.password){alert("Wrong old password");return;}
if(newPass.value!==cnfPass.value){alert("Password not match");return;}
currentUser.password=newPass.value;
saveAll();
alert("Password Changed");
}

function initTeam(){
tname.innerText=currentUser.name;
tloc.innerText=currentUser.location;
bal.innerText=currentUser.advance||0;
edate.valueAsDate=new Date();
loadTeam();
}

function saveExpense(){
let amt=Number(eamt.value);
DATA.push({
username:currentUser.username,
date:edate.value,
detail:edesc.value,
amount:amt,
status:"Pending"
});
saveAll();
}

function loadTeam(){
teamTable.innerHTML="";
DATA.filter(d=>d.username===currentUser.username).forEach(d=>{
teamTable.innerHTML+=`
<tr class="pending">
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.amount}</td>
<td>${d.status}</td>
</tr>`;
});
}

function loadSup(){
supTable.innerHTML="";
DATA.forEach((d,i)=>{
supTable.innerHTML+=`
<tr class="${d.status==='Approved'?'approved':d.status==='Rejected'?'rejected':'pending'}">
<td>${d.username}</td>
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.amount}</td>
<td>${d.status}</td>
<td>
<button onclick="approve(${i})">Approve</button>
<button onclick="reject(${i})">Reject</button>
</td>
</tr>`;
});
}

function approve(i){DATA[i].status="Approved";saveAll();}
function reject(i){DATA[i].status="Rejected";saveAll();}

function loadAdmin(){
userTable.innerHTML="";
USERS.forEach(u=>{
userTable.innerHTML+=`
<tr>
<td>${u.username}</td>
<td>${u.name||""}</td>
<td>${u.role}</td>
<td>${u.location||""}</td>
<td>${u.advance||0}</td>
</tr>`;
});

adminTable.innerHTML="";
DATA.forEach(d=>{
adminTable.innerHTML+=`
<tr class="${d.status==='Approved'?'approved':d.status==='Rejected'?'rejected':'pending'}">
<td>${d.username}</td>
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.amount}</td>
<td>${d.status}</td>
<td>-</td>
</tr>`;
});
}

function createUser(){
USERS.push({
username:cu.value,
password:cp.value,
name:cn.value,
location:cl.value,
role:cr.value,
advance:0
});
saveAll();
}

function saveAll(){
localStorage.setItem("USERS",JSON.stringify(USERS));
localStorage.setItem("DATA",JSON.stringify(DATA));
if(currentUser?.role==="admin")loadAdmin();
if(currentUser?.role==="supervisor")loadSup();
if(currentUser?.role==="team")loadTeam();
}
</script>

</body>
</html>
