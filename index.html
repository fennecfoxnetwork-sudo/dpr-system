<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbxG6Di2BRNd1cieq0rj12DTUIxa6hUtr-fTqqn0I-kqIGFg0etqxDdmDwvPVFwJsShE/exec";

let USERS=JSON.parse(localStorage.getItem("USERS"))||[
{username:"admin",password:"admin",role:"admin",name:"Admin",advance:0},
{username:"sup",password:"sup",role:"supervisor",name:"Supervisor",advance:0},
{username:"team",password:"team",role:"team",name:"Team",location:"Site-1",advance:0}
];

let DATA=JSON.parse(localStorage.getItem("DATA"))||[];
let currentUser=JSON.parse(localStorage.getItem("SESSION"))||null;

/* ===== AUTO LOGIN AFTER REFRESH ===== */
window.onload=()=>{
if(currentUser){
loginBox.classList.add("hidden");
if(currentUser.role==="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
if(currentUser.role==="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
if(currentUser.role==="team"){teamPanel.classList.remove("hidden");initTeam();}
}
}

/* ===== LOGIN ===== */
function login(){
let u=USERS.find(x=>x.username===luser.value && x.password===lpass.value);
if(!u)return alert("Wrong Login");
currentUser=u;
localStorage.setItem("SESSION",JSON.stringify(u));
location.reload();
}

function logout(){
localStorage.removeItem("SESSION");
location.reload();
}

/* ===== GOOGLE SHEET PUSH ===== */
function pushToSheet(row){
fetch(SHEET_URL,{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify(row)
});
}

/* ===== TEAM ===== */
function initTeam(){
tname.innerText=currentUser.name;
tloc.innerText=currentUser.location;
bal.innerText=currentUser.advance||0;
cdate.valueAsDate=edate.valueAsDate=new Date();
loadTeam();
}

function calcConv(){
ctotal.value=(+cmem.value||0)*(+cper.value||0);
}

function saveConveyance(){
let amt=+ctotal.value;
if(!amt) return alert("Amount missing");

let row={
timestamp:new Date().toLocaleString(),
username:currentUser.username,
role:currentUser.role,
date:cdate.value,
detail:`Conveyance ${cmode.value} ${cfrom.value} to ${cto.value}`,
status:"Pending",
payment:amt
};

DATA.push(row);
currentUser.advance-=amt;
pushToSheet(row);
saveAll();
alert("Conveyance submitted");
}

function saveExpense(){
let amt=+eamt.value;
if(!amt) return alert("Amount missing");

let row={
timestamp:new Date().toLocaleString(),
username:currentUser.username,
role:currentUser.role,
date:edate.value,
detail:`Expense (${ecat.value}) - ${edesc.value}`,
status:"Pending",
payment:amt
};

DATA.push(row);
currentUser.advance-=amt;
pushToSheet(row);
saveAll();
alert("Expense submitted");
}

function loadTeam(){
bal.innerText=currentUser.advance||0;
teamTable.innerHTML="";
DATA.filter(d=>d.username===currentUser.username).forEach(d=>{
teamTable.innerHTML+=`
<tr class="pending">
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.payment}</td>
<td>${d.status}</td>
</tr>`;
});
}

/* ===== SUPERVISOR ===== */
function loadSup(){
supTable.innerHTML="";
DATA.forEach((d,i)=>{
supTable.innerHTML+=`
<tr class="pending">
<td>${d.username}</td>
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.payment}</td>
<td>${d.status}</td>
<td>
<button onclick="approve(${i})">Approve</button>
<button onclick="reject(${i})">Reject</button>
</td>
</tr>`;
});
}

function approve(i){
DATA[i].status="Approved";
saveAll();
}

function reject(i){
DATA[i].status="Rejected";
saveAll();
}

/* ===== ADMIN ===== */
function loadAdmin(){
/* USERS TABLE */
userTable.innerHTML="";
USERS.forEach((u,i)=>{
userTable.innerHTML+=`
<tr>
<td>${u.username}</td>
<td>${u.name||""}</td>
<td>${u.role}</td>
<td>${u.location||""}</td>
<td>${u.advance||0}</td>
<td><button onclick="deleteUser(${i})">Delete</button></td>
</tr>`;
});

/* GIVE ADVANCE DROPDOWN (FIXED) */
advUser.innerHTML="";
USERS.filter(u=>u.role!=="admin").forEach(u=>{
advUser.innerHTML+=`<option value="${u.username}">${u.username}</option>`;
});

/* APPROVED TABLE */
adminTable.innerHTML="";
let paid=0,pend=0;
DATA.filter(d=>d.status==="Approved").forEach((d,i)=>{
if(d.paid) paid+=d.payment; else pend+=d.payment;
adminTable.innerHTML+=`
<tr>
<td>${d.username}</td>
<td>${d.date}</td>
<td>${d.detail}</td>
<td>${d.payment}</td>
<td>${d.status}</td>
<td>${d.paid?"Paid":"Unpaid"}</td>
<td>
<button onclick="markPaid(${i})">Paid</button>
<button onclick="markUnpaid(${i})">Unpaid</button>
</td>
</tr>`;
});
paidT.innerText=paid;
pendT.innerText=pend;
}

function deleteUser(i){
USERS.splice(i,1);
saveAll();
}

function markPaid(i){
DATA[i].paid=true;
saveAll();
}

function markUnpaid(i){
DATA[i].paid=false;
saveAll();
}

/* ===== CREATE USER ===== */
function createUser(){
if(!cu.value||!cp.value) return alert("Username/Password missing");
USERS.push({
username:cu.value,
password:cp.value,
name:cn.value,
location:cl.value,
role:cr.value,
advance:0
});
saveAll();
alert("User created");
}

/* ===== GIVE ADVANCE (FIXED) ===== */
function giveAdvance(){
let u=USERS.find(x=>x.username===advUser.value);
if(!u) return alert("User not found");
u.advance += Number(advAmt.value||0);
advAmt.value="";
saveAll();
alert("Advance added");
}

/* ===== SAVE ===== */
function saveAll(){
localStorage.setItem("USERS",JSON.stringify(USERS));
localStorage.setItem("DATA",JSON.stringify(DATA));
localStorage.setItem("SESSION",JSON.stringify(currentUser));

if(currentUser.role==="admin") loadAdmin();
if(currentUser.role==="supervisor") loadSup();
if(currentUser.role==="team") loadTeam();
}
</script>
