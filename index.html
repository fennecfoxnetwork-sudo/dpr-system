<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DPR System – Final One Page</title>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h2{color:#fff;padding:10px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:6px}
input,select,button,textarea{width:100%;padding:6px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Create User</h3>
Username <input id="cu">
Password <input id="cp">
Name <input id="cn">
Location <input id="cl">
Role
<select id="cr">
<option value="team">Team</option>
<option value="supervisor">Supervisor</option>
</select>
<button onclick="createUser()">Create User</button>
</div>

<div class="box">
<h3>Give Advance</h3>
User
<select id="advUser"></select>
Amount
<input type="number" id="advAmt">
<button onclick="giveAdvance()">Give Advance</button>
</div>

<div class="box">
<h3>Existing Users</h3>
<table>
<thead>
<tr>
<th>User</th><th>Name</th><th>Role</th><th>Location</th><th>Advance</th>
</tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<p>No action required</p>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span><br>
<b>Advance Balance:</b> ₹<span id="bal"></span>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
/* ================= DATA ================= */
let USERS = JSON.parse(localStorage.getItem("USERS")) || [
 {username:"admin",password:"admin",role:"admin",name:"Admin",advance:0},
 {username:"team",password:"team",role:"team",name:"Team",location:"Site-1",advance:0}
];

let currentUser = JSON.parse(localStorage.getItem("SESSION")) || null;

/* ================= AUTO LOGIN ================= */
window.onload = function(){
 if(currentUser){
  document.getElementById("loginBox").classList.add("hidden");
  if(currentUser.role==="admin"){
   document.getElementById("adminPanel").classList.remove("hidden");
   loadAdmin();
  }
  if(currentUser.role==="team"){
   document.getElementById("teamPanel").classList.remove("hidden");
   initTeam();
  }
 }
};

/* ================= LOGIN ================= */
function login(){
 let u = USERS.find(x =>
  x.username === document.getElementById("luser").value &&
  x.password === document.getElementById("lpass").value
 );
 if(!u){ alert("Wrong login"); return; }
 currentUser = u;
 localStorage.setItem("SESSION", JSON.stringify(u));
 location.reload();
}

function logout(){
 localStorage.removeItem("SESSION");
 location.reload();
}

/* ================= ADMIN ================= */
function loadAdmin(){
 const userTable = document.getElementById("userTable");
 const advUser = document.getElementById("advUser");

 userTable.innerHTML="";
 advUser.innerHTML="";

 USERS.forEach(u=>{
  userTable.innerHTML += `
   <tr>
    <td>${u.username}</td>
    <td>${u.name||""}</td>
    <td>${u.role}</td>
    <td>${u.location||""}</td>
    <td>${u.advance||0}</td>
   </tr>`;
 });

 USERS.filter(u=>u.role!=="admin").forEach(u=>{
  advUser.innerHTML += `<option value="${u.username}">${u.username}</option>`;
 });
}

function createUser(){
 if(!cu.value || !cp.value){ alert("Missing fields"); return; }

 USERS.push({
  username:cu.value,
  password:cp.value,
  name:cn.value,
  location:cl.value,
  role:cr.value,
  advance:0
 });

 saveAll();
 alert("User created");
}

/* ================= GIVE ADVANCE (FIXED) ================= */
function giveAdvance(){
 const advUser = document.getElementById("advUser");
 const advAmt  = document.getElementById("advAmt");

 let u = USERS.find(x=>x.username===advUser.value);
 if(!u){ alert("Select user"); return; }

 u.advance += Number(advAmt.value || 0);
 advAmt.value="";

 saveAll();
 alert("Advance added");
}

/* ================= TEAM ================= */
function initTeam(){
 document.getElementById("tname").innerText = currentUser.name;
 document.getElementById("tloc").innerText  = currentUser.location;
 document.getElementById("bal").innerText   = currentUser.advance || 0;
}

/* ================= SAVE ================= */
function saveAll(){
 localStorage.setItem("USERS", JSON.stringify(USERS));
 localStorage.setItem("SESSION", JSON.stringify(currentUser));

 if(currentUser.role==="admin") loadAdmin();
 if(currentUser.role==="team") initTeam();
}
</script>

</body>
</html>
