<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DPR System – Final One Page</title>

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h2{color:#fff;padding:10px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:6px}
input,select,button,textarea{width:100%;padding:6px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
.paid{background:#cfe2ff}
.unpaid{background:#ffe5b4}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Create User</h3>
Username <input id="cu">
Password <input id="cp">
Name <input id="cn">
Location <input id="cl">
Role
<select id="cr">
<option value="team">Team</option>
<option value="supervisor">Supervisor</option>
</select>
<button onclick="createUser()">Create User</button>
</div>

<div class="box">
<h3>Existing Users</h3>
<table>
<thead>
<tr><th>User</th><th>Name</th><th>Role</th><th>Location</th><th>Advance</th><th>Action</th></tr>
</thead>
<tbody id="userTable"></tbody>
</table>
</div>

<div class="box">
<h3>Approved Entries</h3>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th><th>Amount</th><th>Status</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
<button onclick="downloadExcel()">⬇ Download Excel</button>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Action</th>
</tr>
</thead>
<tbody id="supTable"></tbody>
</table>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span>
</div>

<div class="box">
<h3>Expense</h3>
Date <input type="date" id="edate">
Description <input id="edesc">
Amount <input type="number" id="eamt">
<button onclick="saveExpense()">Submit</button>
</div>

<div class="box">
<h3>My Entries</h3>
<table>
<thead>
<tr><th>Date</th><th>Detail</th><th>Amount</th><th>Status</th></tr>
</thead>
<tbody id="teamTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbxG6Di2BRNd1cieq0rj12DTUIxa6hUtr-fTqqn0I-kqIGFg0etqxDdmDwvPVFwJsShE/exec";

let USERS=JSON.parse(localStorage.getItem("USERS"))||[
{username:"admin",password:"admin",role:"admin",name:"Admin"},
{username:"sup",password:"sup",role:"supervisor",name:"Supervisor"},
{username:"team",password:"team",role:"team",name:"Team",location:"Site-1"}
];

let DATA=JSON.parse(localStorage.getItem("DATA"))||[];
let currentUser=JSON.parse(localStorage.getItem("CURRENT_USER"))||null;

/* ===== AUTO LOGIN ===== */
if(currentUser){
loginBox.classList.add("hidden");
openPanel(currentUser);
}

/* ===== LOGIN ===== */
function login(){
let u=USERS.find(x=>x.username===luser.value && x.password===lpass.value);
if(!u)return alert("Wrong Login");
currentUser=u;
localStorage.setItem("CURRENT_USER",JSON.stringify(u));
loginBox.classList.add("hidden");
openPanel(u);
}

function logout(){
localStorage.removeItem("CURRENT_USER");
location.reload();
}

function openPanel(u){
if(u.role==="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
if(u.role==="supervisor"){supervisorPanel.classList.remove("hidden");loadSup();}
if(u.role==="team"){teamPanel.classList.remove("hidden");initTeam();}
}

/* ===== TEAM ===== */
function initTeam(){
tname.innerText=currentUser.name;
tloc.innerText=currentUser.location;
edate.valueAsDate=new Date();
loadTeam();
}

function saveExpense(){
let e={
timestamp:new Date().toISOString(),
username:currentUser.username,
role:currentUser.role,
date:edate.value,
detail:edesc.value,
amount:eamt.value,
status:"Pending"
};
DATA.push(e);
saveAll();
sendToSheet(e);
}

function loadTeam(){
teamTable.innerHTML="";
DATA.filter(d=>d.username===currentUser.username).forEach(d=>{
let c=d.status==="Approved"?"approved":"pending";
teamTable.innerHTML+=`<tr class="${c}">
<td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td><td>${d.status}</td></tr>`;
});
}

/* ===== SUPERVISOR ===== */
function loadSup(){
supTable.innerHTML="";
DATA.filter(d=>d.status==="Pending").forEach((d,i)=>{
supTable.innerHTML+=`<tr class="pending">
<td>${d.username}</td><td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td>
<td>${d.status}</td>
<td>
<button onclick="approve(${i})">Approve</button>
<button onclick="reject(${i})">Reject</button>
</td></tr>`;
});
}

function approve(i){DATA[i].status="Approved";saveAll();}
function reject(i){DATA[i].status="Rejected";saveAll();}

/* ===== ADMIN ===== */
function loadAdmin(){
userTable.innerHTML="";
USERS.forEach((u,i)=>{
if(u.role!=="admin"){
userTable.innerHTML+=`<tr>
<td>${u.username}</td><td>${u.name}</td><td>${u.role}</td><td>${u.location||""}</td>
<td>0</td>
<td><button onclick="USERS.splice(${i},1);saveAll()">Delete</button></td>
</tr>`;
}
});

adminTable.innerHTML="";
DATA.filter(d=>d.status==="Approved").forEach(d=>{
adminTable.innerHTML+=`<tr class="approved">
<td>${d.username}</td><td>${d.date}</td><td>${d.detail}</td><td>${d.amount}</td><td>${d.status}</td>
</tr>`;
});
}

/* ===== GOOGLE SHEET ===== */
function sendToSheet(e){
fetch(SHEET_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(e)
});
}

/* ===== EXCEL ===== */
function downloadExcel(){
let rows=[["username","date","detail","amount","status"]];
DATA.filter(d=>d.status==="Approved").forEach(d=>{
rows.push([d.username,d.date,d.detail,d.amount,d.status]);
});
let csv=rows.map(r=>r.join(",")).join("\n");
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
a.download="DPR_DATA.csv";
a.click();
}

/* ===== SAVE ===== */
function saveAll(){
localStorage.setItem("USERS",JSON.stringify(USERS));
localStorage.setItem("DATA",JSON.stringify(DATA));
if(currentUser)openPanel(currentUser);
}
</script>

</body>
</html>
