<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DPR System – Final One Page</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f2f2f2;padding:20px}
h2{color:#fff;padding:10px}
.admin{background:#0d6efd}
.supervisor{background:#b02a37}
.team{background:#198754}
.box{background:#fff;padding:15px;margin-bottom:15px;border-radius:6px}
input,select,button,textarea{width:100%;padding:6px;margin:4px 0}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
.hidden{display:none}
.pending{background:#fff3cd}
.approved{background:#d1e7dd}
.rejected{background:#f8d7da}
.paid{background:#cfe2ff}
.unpaid{background:#ffe5b4}

@media(max-width:768px){
  body{padding:10px}
  table{font-size:12px}
}
</style>
</head>

<body>

<h2 class="admin">LOGIN</h2>
<div class="box" id="loginBox">
Username <input id="luser">
Password <input id="lpass" type="password">
<button onclick="login()">Login</button>
</div>

<!-- ================= ADMIN ================= -->
<div id="adminPanel" class="hidden">
<h2 class="admin">ADMIN PANEL</h2>

<div class="box">
<h3>Save Approved Data</h3>
<button onclick="saveToSheet()">Save Approved Entries to Google Sheet</button>
</div>

<div class="box">
<h3>Approved Entries</h3>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th><th>Amount</th>
<th>Status</th><th>Payment</th><th>Action</th>
</tr>
</thead>
<tbody id="adminTable"></tbody>
</table>
</div>

<button onclick="logout()">Logout</button>
</div>

<!-- ================= SUPERVISOR ================= -->
<div id="supervisorPanel" class="hidden">
<h2 class="supervisor">SUPERVISOR PANEL</h2>
<table>
<thead>
<tr>
<th>User</th><th>Date</th><th>Detail</th>
<th>Amount</th><th>Status</th><th>Comment</th><th>Action</th>
</tr>
</thead>
<tbody id="supTable"></tbody>
</table>
<button onclick="logout()">Logout</button>
</div>

<!-- ================= TEAM ================= -->
<div id="teamPanel" class="hidden">
<h2 class="team">TEAM PANEL</h2>

<div class="box">
<b>Name:</b> <span id="tname"></span><br>
<b>Project:</b> <span id="tloc"></span><br>
<b>Advance Balance:</b> ₹<span id="bal"></span>
</div>

<div class="box">
<button onclick="toggleBox('convBox')">➕ CONVEYANCE</button>
<button onclick="toggleBox('expBox')">➕ EXPENSE</button>
</div>

<div class="box hidden" id="convBox">
Date <input type="date" id="cdate">
From <input id="cfrom">
To <input id="cto">
Members <input type="number" id="cmem" value="1" oninput="calcConv()">
Amount/Person <input type="number" id="cper" oninput="calcConv()">
Total <input type="number" id="ctotal">
<button onclick="saveConveyance()">Submit</button>
</div>

<div class="box hidden" id="expBox">
Date <input type="date" id="edate">
Description <input id="edesc">
Amount <input type="number" id="eamt">
<button onclick="saveExpense()">Submit</button>
</div>

<button onclick="logout()">Logout</button>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxG6Di2BRNd1cieq0rj12DTUIxa6hUtr-fTqqn0I-kqIGFg0etqxDdmDwvPVFwJsShE/exec";

let USERS=JSON.parse(localStorage.getItem("USERS"))||[
{username:"admin",password:"admin",role:"admin",name:"Admin"}
];
let DATA=JSON.parse(localStorage.getItem("DATA"))||[];
let currentUser=JSON.parse(localStorage.getItem("CURRENT_USER"));

if(currentUser){
loginBox.classList.add("hidden");
if(currentUser.role=="admin"){adminPanel.classList.remove("hidden");loadAdmin();}
}

function login(){
let u=USERS.find(x=>x.username==luser.value && x.password==lpass.value);
if(!u)return alert("Wrong Login");
currentUser=u;
localStorage.setItem("CURRENT_USER",JSON.stringify(u));
loginBox.classList.add("hidden");
adminPanel.classList.remove("hidden");
loadAdmin();
}

function logout(){
localStorage.removeItem("CURRENT_USER");
location.reload();
}

function toggleBox(id){
convBox.classList.add("hidden");
expBox.classList.add("hidden");
document.getElementById(id).classList.remove("hidden");
}

function calcConv(){
ctotal.value=(+cmem.value||0)*(+cper.value||0);
}

function saveConveyance(){
DATA.push({user:currentUser.username,date:cdate.value,detail:"Conveyance",amount:+ctotal.value,status:"Approved"});
saveAll();
}

function saveExpense(){
DATA.push({user:currentUser.username,date:edate.value,detail:edesc.value,amount:+eamt.value,status:"Approved"});
saveAll();
}

function loadAdmin(){
adminTable.innerHTML="";
DATA.forEach((d,i)=>{
adminTable.innerHTML+=`
<tr>
<td>${d.user}</td><td>${d.date}</td><td>${d.detail}</td>
<td>${d.amount}</td><td>${d.status}</td>
<td>${d.paid?"Paid":"Unpaid"}</td>
<td>
<button onclick="DATA[${i}].paid=true;saveAll()">Paid</button>
</td>
</tr>`;
});
}

function saveAll(){
localStorage.setItem("DATA",JSON.stringify(DATA));
loadAdmin();
}

/* ✅ ADMIN → GOOGLE SHEET SAVE */
function saveToSheet(){
let approved=DATA.filter(d=>d.status=="Approved");
fetch(SCRIPT_URL,{
method:"POST",
body:JSON.stringify(approved)
}).then(r=>alert("Data saved to Google Sheet"));
}
</script>

</body>
</html>
